/**
 * KineticJS JavaScript Library v3.1.0
 * http://www.kineticjs.com/
 * Copyright 2011, Eric Rowell
 * Licensed under the MIT or GPL Version 2 licenses.
 * Date: Dec 19 2011
 *
 * Copyright (C) 2011 by Eric Rowell
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */
var Kinetic={};Kinetic.Layer=function(b,a){this.canvas=document.createElement("canvas");this.context=this.canvas.getContext("2d");this.canvas.width=b.width;this.canvas.height=b.height;this.canvas.style.position="absolute";this.shapes=[];if(a){this.context.stroke=function(){};this.context.fill=function(){}}b.container.appendChild(this.canvas)};Kinetic.Layer.prototype.clear=function(){var b=this.getContext();var a=this.getCanvas();b.clearRect(0,0,a.width,a.height)};Kinetic.Layer.prototype.getCanvas=function(){return this.canvas};Kinetic.Layer.prototype.getContext=function(){return this.context};Kinetic.Layer.prototype.getShapes=function(){return this.shapes};Kinetic.Layer.prototype.draw=function(){this.clear();var a=this.getContext();for(var b=0;b<this.getShapes().length;b++){this.getShapes()[b].draw(this)}};Kinetic.Stage=function(b,c,a){this.container=document.getElementById(b);this.width=c;this.height=a;this.zIndexCounter=9999;this.idCounter=0;this.dblClickWindow=400;this.mousePos=null;this.mouseDown=false;this.mouseUp=false;this.touchPos=null;this.touchStart=false;this.touchEnd=false;this.backStageLayer=new Kinetic.Layer(this,true);this.stageLayer=new Kinetic.Layer(this);this.propsLayer=new Kinetic.Layer(this);this.actorsLayer=new Kinetic.Layer(this);this.backStageLayer.getCanvas().style.display="none";this.listen()};Kinetic.Stage.prototype.getBackStageLayer=function(){return this.backStageLayer};Kinetic.Stage.prototype.getStageLayer=function(){return this.stageLayer};Kinetic.Stage.prototype.getPropsLayer=function(){return this.propsLayer};Kinetic.Stage.prototype.getActorsLayer=function(){return this.actorsLayer};Kinetic.Stage.prototype.clear=function(){this.stageLayer.clear()};Kinetic.Stage.prototype.clearAll=function(){this.backStageLayer.clear();this.stageLayer.clear();this.propsLayer.clear();this.actorsLayer.clear()};Kinetic.Stage.prototype.draw=function(){this.getActorsLayer().draw()};Kinetic.Stage.prototype.remove=function(b){var a=this.getShapes();for(var d=0;d<a.length;d++){var c=a[d].id;if(c==b.id){b.getLayer().getShapes().splice(d,1)}}};Kinetic.Stage.prototype.removeAll=function(){this.getPropsLayer().shapes=[];this.getActorsLayer().shapes=[]};Kinetic.Stage.prototype.getCanvas=function(){return this.stageLayer.getCanvas()};Kinetic.Stage.prototype.getContext=function(){return this.stageLayer.getContext()};Kinetic.Stage.prototype.addEventListener=function(a,b){this.container.addEventListener(a,b)};Kinetic.Stage.prototype.add=function(a){a.stage=this;if(a.isProp){a.layer=this.propsLayer}else{a.layer=this.actorsLayer}a.getLayer().shapes.push(a);a.id=this.idCounter++;a.draw(a.layer)};Kinetic.Stage.prototype.handleEvent=function(a){if(!a){a=window.event}this.setMousePosition(a);this.setTouchPosition(a);var e=this.backStageLayer;var d=e.getContext();var c=this;e.clear();for(var f=this.getShapes().length-1;f>=0;f--){var b=this.getShapes()[f];(function(){var g=b;g.draw(e);var i=c.touchPos||c.mousePos;var h=g.eventListeners;if(g.visible&&i!==null&&d.isPointInPath(i.x,i.y)){if(c.mouseDown){c.mouseDown=false;g.clickStart=true;if(h.onmousedown!==undefined){h.onmousedown(a)}f=-1}else{if(c.mouseUp){c.mouseUp=false;if(h.onmouseup!==undefined){h.onmouseup(a)}if(g.clickStart){if(h.onclick!==undefined){h.onclick(a)}if(h.ondblclick!==undefined&&g.inDoubleClickWindow){h.ondblclick(a)}g.inDoubleClickWindow=true;setTimeout(function(){g.inDoubleClickWindow=false},c.dblClickWindow)}f=-1}else{if(c.touchStart){c.touchStart=false;if(h.touchstart!==undefined){h.touchstart(a)}f=-1}else{if(c.touchEnd){c.touchEnd=false;if(h.touchend!==undefined){h.touchend(a)}f=-1}else{if(h.touchmove!==undefined){h.touchmove(a);f=-1}else{if(!g.mouseOver){g.mouseOver=true;if(h.onmouseover!==undefined){h.onmouseover(a)}f=-1}else{if(h.onmousemove!==undefined){h.onmousemove(a);f=-1}}}}}}}}else{if(g.mouseOver){g.mouseOver=false;if(h.onmouseout!==undefined){h.onmouseout(a)}f=-1}}}())}};Kinetic.Stage.prototype.listen=function(){var a=this;this.container.addEventListener("mousedown",function(b){a.mouseDown=true;a.handleEvent(b)},false);this.container.addEventListener("mousemove",function(b){a.mouseUp=false;a.mouseDown=false;a.handleEvent(b)},false);this.container.addEventListener("mouseup",function(b){a.mouseUp=true;a.mouseDown=false;a.handleEvent(b);for(var c=0;c<a.getShapes().length;c++){a.getShapes()[c].clickStart=false}},false);this.container.addEventListener("mouseover",function(b){a.handleEvent(b)},false);this.container.addEventListener("mouseout",function(b){a.mousePos=null},false);this.container.addEventListener("touchstart",function(b){b.preventDefault();a.touchStart=true;a.handleEvent(b)},false);this.container.addEventListener("touchmove",function(b){b.preventDefault();a.handleEvent(b)},false);this.container.addEventListener("touchend",function(b){b.preventDefault();a.touchEnd=true;a.handleEvent(b)},false)};Kinetic.Stage.prototype.getMousePos=function(a){return this.mousePos};Kinetic.Stage.prototype.getTouchPos=function(a){return this.touchPos};Kinetic.Stage.prototype.setMousePosition=function(a){var c=a.clientX-this.getContainerPos().left+window.pageXOffset;var b=a.clientY-this.getContainerPos().top+window.pageYOffset;this.mousePos={x:c,y:b}};Kinetic.Stage.prototype.setTouchPosition=function(c){if(c.touches!==undefined&&c.touches.length==1){var d=c.touches[0];var b=d.clientX-this.getContainerPos().left+window.pageXOffset;var a=d.clientY-this.getContainerPos().top+window.pageYOffset;this.touchPos={x:b,y:a}}};Kinetic.Stage.prototype.getContainerPos=function(){var c=this.container;var b=0;var a=0;while(c.tagName!="BODY"){b+=c.offsetTop;a+=c.offsetLeft;c=c.offsetParent}return{top:b,left:a}};Kinetic.Stage.prototype.getContainer=function(){return this.container};Kinetic.Stage.prototype.getShapes=function(){return(this.getPropsLayer().getShapes()).concat(this.getActorsLayer().getShapes())};Kinetic.Shape=function(b,a){this.drawFunc=b;this.isProp=a===undefined?false:a;this.x=0;this.y=0;this.scale={x:1,y:1};this.rotation=0;this.lastX=0;this.lastY=0;this.lastRotation=0;this.lastScale={x:1,y:1};this.eventListeners={};this.mouseOver=false;this.clickStart=false;this.inDblClickWindow=false;this.visible=true};Kinetic.Shape.prototype.getStage=function(){return this.stage};Kinetic.Shape.prototype.draw=function(c){if(this.visible){var a=this.getStage();var b=c.getContext();b.save();if(this.x!==0||this.y!==0){b.translate(this.x,this.y)}if(this.rotation!==0){b.rotate(this.rotation)}if(this.scale.x!=1||this.scale.y!=1){b.scale(this.scale.x,this.scale.y)}this.drawFunc.call(c);b.restore()}};Kinetic.Shape.prototype.setScale=function(a){this.scale.x=a;this.scale.y=a};Kinetic.Shape.prototype.addEventListener=function(a,c){var b=(a.indexOf("touch")==-1)?"on"+a:a;this.eventListeners[b]=c};Kinetic.Shape.prototype.show=function(){this.visible=true};Kinetic.Shape.prototype.hide=function(){this.visible=false};Kinetic.Shape.prototype.moveToTop=function(){var c=this.stage;var d=this.getLayer();var a=d.getShapes();for(var e=0;e<a.length;e++){var b=a[e];if(b.id==this.id){d.shapes.splice(e,1);d.shapes.push(this);break}}};Kinetic.Shape.prototype.getLayer=function(){return this.layer};Kinetic.drawImage=function(d,b,e,c,a){if(!c){c=d.width}if(!a){a=d.height}return function(){var f=this.getContext();f.drawImage(d,b,e,c,a);f.beginPath();f.rect(b,e,c,a);f.closePath()}};